#!/usr/bin/env bash

set -eE

# usage: run [-f PR] [-t PR] [-s STEP]
#
# -f PR             from pull request (excluded)
# -t PR             to pull request (excluded)
# -s STEP           every n pull requests
#
# Change test plans in `bin/plan`.
#

source bin/config

args="$@"

plans=$(cat bin/plan | grep "^measure")

function report {
  content=$(tail -n 20 $log_file)
  message="regression failed for following benchmarks:

arguments: $args

$plans

Error message:

$content


[check $log_file for more information]"

  ghi comment $MONITOR_ISSUE -m "$message" -- $MONITOR_REPO
}

trap report ERR

cd /data/workspace/bench
log_file=logs/$(date +%m-%d-%H.%M)-regression.out

bin/schedule $args -o regression.csv > $log_file 2>&1

cat regression.csv | cat - history.csv > temp.csv && mv temp.csv history.csv

bin/deploy   > $log_file 2>&1

git add history.csv
git commit -m "[bot]add data to history" > $log_file 2>&1
git push origin master:master > $log_file 2>&1

message="regression finished successfully:

arguments: $args

$plans

Visit $WEB_URL to see the changes."

ghi comment $MONITOR_ISSUE -m "$message" -- $MONITOR_REPO

# restore plan
rm regression.csv
