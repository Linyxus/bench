#!/usr/bin/env bash

report() {
  message="job queue exception

job queue exception"

  ghi open -m "$message" -- liufengyun/bench

  exit 1
}

# trap report INT TERM EXIT
trap report EXIT

# job queue service

while true; do
  files=$(ls jobs/*.job 2>/dev/null) # don't use `(jobs/*.job)` for array, it doesn't work in tmux
  total=$(echo $files | wc -w)

  if [ "$total" != "0" ]; then
    first=$(echo $files | cut -d' ' -f1)  # don't use array, it's buggy
    base=${first%.job}

    mv "$base.job" "$base.running"
    bash "$base.running"

    rc=$?
    if [[ $rc != 0 ]]; then
      mv "$base.running" "$base.fail"
    else
      mv "$base.running" "$base.done"
    fi

  else
    sleep 60
  fi
done
