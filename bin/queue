#!/usr/bin/env bash

report() {
  read -r -d '' message << EOF
job queue exception

job queue exception
EOF

  ghi open -m "$message" -- liufengyun/bench

  exit 1
}

# trap report INT TERM EXIT
trap report EXIT

# job queue service

while true; do
  files=$(ls jobs/*.job 2>/dev/null) # don't use `(jobs/*.job)` for array, it doesn't work in tmux
  total=$(echo $files | wc -w)

  if [ "$total" != "0" ]; then
    first=$(echo $files | cut -d' ' -f1)  # don't use array, it's buggy

    bash $first

    rc=$?
    if [[ $rc != 0 ]]; then
      mv "$first" "${first%.job}.fail"
    else
      mv "$first" "${first%.job}.done"
    fi

  else
    sleep 60
  fi
done
